/**
 * skylark-handlebars - A version of handlebars.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-handlebars/
 * @license MIT
 */
define(["../exception","../utils","./ast"],function(t,e,s){"use strict";const o=[].slice;function i(){}function p(t,s){if(t===s)return!0;if(e.isArray(t)&&e.isArray(s)&&t.length===s.length){for(let e=0;e<t.length;e++)if(!p(t[e],s[e]))return!1;return!0}}function r(t){if(!t.path.parts){let e=t.path;t.path={type:"PathExpression",data:!1,depth:0,parts:[e.original+""],original:e.original+"",loc:e.loc}}}return i.prototype={compiler:i,equals:function(t){let e=this.opcodes.length;if(t.opcodes.length!==e)return!1;for(let s=0;s<e;s++){let e=this.opcodes[s],o=t.opcodes[s];if(e.opcode!==o.opcode||!p(e.args,o.args))return!1}e=this.children.length;for(let s=0;s<e;s++)if(!this.children[s].equals(t.children[s]))return!1;return!0},guid:0,compile:function(t,s){return this.sourceNode=[],this.opcodes=[],this.children=[],this.options=s,this.stringParams=s.stringParams,this.trackIds=s.trackIds,s.blockParams=s.blockParams||[],s.knownHelpers=e.extend(Object.create(null),{helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},s.knownHelpers),this.accept(t)},compileProgram:function(t){let e=(new this.compiler).compile(t,this.options),s=this.guid++;return this.usePartial=this.usePartial||e.usePartial,this.children[s]=e,this.useDepths=this.useDepths||e.useDepths,s},accept:function(e){if(!this[e.type])throw new t("Unknown type: "+e.type,e);this.sourceNode.unshift(e);let s=this[e.type](e);return this.sourceNode.shift(),s},Program:function(t){this.options.blockParams.unshift(t.blockParams);let e=t.body,s=e.length;for(let t=0;t<s;t++)this.accept(e[t]);return this.options.blockParams.shift(),this.isSimple=1===s,this.blockParams=t.blockParams?t.blockParams.length:0,this},BlockStatement:function(t){r(t);let e=t.program,s=t.inverse;e=e&&this.compileProgram(e),s=s&&this.compileProgram(s);let o=this.classifySexpr(t);"helper"===o?this.helperSexpr(t,e,s):"simple"===o?(this.simpleSexpr(t),this.opcode("pushProgram",e),this.opcode("pushProgram",s),this.opcode("emptyHash"),this.opcode("blockValue",t.path.original)):(this.ambiguousSexpr(t,e,s),this.opcode("pushProgram",e),this.opcode("pushProgram",s),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock(t){let e=t.program&&this.compileProgram(t.program),s=this.setupFullMustacheParams(t,e,void 0),o=t.path;this.useDecorators=!0,this.opcode("registerDecorator",s.length,o.original)},PartialStatement:function(e){this.usePartial=!0;let s=e.program;s&&(s=this.compileProgram(e.program));let o=e.params;if(o.length>1)throw new t("Unsupported number of partial arguments: "+o.length,e);o.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):o.push({type:"PathExpression",parts:[],depth:0}));let i=e.name.original,p="SubExpression"===e.name.type;p&&this.accept(e.name),this.setupFullMustacheParams(e,s,void 0,!0);let r=e.indent||"";this.options.preventIndent&&r&&(this.opcode("appendContent",r),r=""),this.opcode("invokePartial",p,i,r),this.opcode("append")},PartialBlockStatement:function(t){this.PartialStatement(t)},MustacheStatement:function(t){this.SubExpression(t),t.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator(t){this.DecoratorBlock(t)},ContentStatement:function(t){t.value&&this.opcode("appendContent",t.value)},CommentStatement:function(){},SubExpression:function(t){r(t);let e=this.classifySexpr(t);"simple"===e?this.simpleSexpr(t):"helper"===e?this.helperSexpr(t):this.ambiguousSexpr(t)},ambiguousSexpr:function(t,e,s){let o=t.path,i=o.parts[0],p=null!=e||null!=s;this.opcode("getContext",o.depth),this.opcode("pushProgram",e),this.opcode("pushProgram",s),o.strict=!0,this.accept(o),this.opcode("invokeAmbiguous",i,p)},simpleSexpr:function(t){let e=t.path;e.strict=!0,this.accept(e),this.opcode("resolvePossibleLambda")},helperSexpr:function(e,o,i){let p=this.setupFullMustacheParams(e,o,i),r=e.path,a=r.parts[0];if(this.options.knownHelpers[a])this.opcode("invokeKnownHelper",p.length,a);else{if(this.options.knownHelpersOnly)throw new t("You specified knownHelpersOnly, but used the unknown helper "+a,e);r.strict=!0,r.falsy=!0,this.accept(r),this.opcode("invokeHelper",p.length,r.original,s.helpers.simpleId(r))}},PathExpression:function(t){this.addDepth(t.depth),this.opcode("getContext",t.depth);let e=t.parts[0],o=s.helpers.scopedId(t),i=!t.depth&&!o&&this.blockParamIndex(e);i?this.opcode("lookupBlockParam",i,t.parts):e?t.data?(this.options.data=!0,this.opcode("lookupData",t.depth,t.parts,t.strict)):this.opcode("lookupOnContext",t.parts,t.falsy,t.strict,o):this.opcode("pushContext")},StringLiteral:function(t){this.opcode("pushString",t.value)},NumberLiteral:function(t){this.opcode("pushLiteral",t.value)},BooleanLiteral:function(t){this.opcode("pushLiteral",t.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(t){let e=t.pairs,s=0,o=e.length;for(this.opcode("pushHash");s<o;s++)this.pushParam(e[s].value);for(;s--;)this.opcode("assignToHash",e[s].key);this.opcode("popHash")},opcode:function(t){this.opcodes.push({opcode:t,args:o.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(t){t&&(this.useDepths=!0)},classifySexpr:function(t){let e=s.helpers.simpleId(t.path),o=e&&!!this.blockParamIndex(t.path.parts[0]),i=!o&&s.helpers.helperExpression(t),p=!o&&(i||e);if(p&&!i){let e=t.path.parts[0],s=this.options;s.knownHelpers[e]?i=!0:s.knownHelpersOnly&&(p=!1)}return i?"helper":p?"ambiguous":"simple"},pushParams:function(t){for(let e=0,s=t.length;e<s;e++)this.pushParam(t[e])},pushParam:function(t){let e=null!=t.value?t.value:t.original||"";if(this.stringParams)e.replace&&(e=e.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),t.depth&&this.addDepth(t.depth),this.opcode("getContext",t.depth||0),this.opcode("pushStringParam",e,t.type),"SubExpression"===t.type&&this.accept(t);else{if(this.trackIds){let o;if(!t.parts||s.helpers.scopedId(t)||t.depth||(o=this.blockParamIndex(t.parts[0])),o){let e=t.parts.slice(1).join(".");this.opcode("pushId","BlockParam",o,e)}else(e=t.original||e).replace&&(e=e.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",t.type,e)}this.accept(t)}},setupFullMustacheParams:function(t,e,s,o){let i=t.params;return this.pushParams(i),this.opcode("pushProgram",e),this.opcode("pushProgram",s),t.hash?this.accept(t.hash):this.opcode("emptyHash",o),i},blockParamIndex:function(t){for(let s=0,o=this.options.blockParams.length;s<o;s++){let o=this.options.blockParams[s],i=o&&e.indexOf(o,t);if(o&&i>=0)return[s,i]}}},{Compiler:i,precompile:function(e,s,o){if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new t("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+e);"data"in(s=s||{})||(s.data=!0),s.compat&&(s.useDepths=!0);let i=o.parse(e,s),p=(new o.Compiler).compile(i,s);return(new o.JavaScriptCompiler).compile(p,s)},compile:function(s,o={},i){if(null==s||"string"!=typeof s&&"Program"!==s.type)throw new t("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+s);let p;function r(){let t=i.parse(s,o),e=(new i.Compiler).compile(t,o),p=(new i.JavaScriptCompiler).compile(e,o,void 0,!0);return i.template(p)}function a(t,e){return p||(p=r()),p.call(this,t,e)}return"data"in(o=e.extend({},o))||(o.data=!0),o.compat&&(o.useDepths=!0),a._setup=function(t){return p||(p=r()),p._setup(t)},a._child=function(t,e,s,o){return p||(p=r()),p._child(t,e,s,o)},a}}});
//# sourceMappingURL=../sourcemaps/compiler/compiler.js.map
